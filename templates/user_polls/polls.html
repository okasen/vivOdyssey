{% extends "base.html" %}

{% block content %}

<div class="container-fluid">
	<form id="question-form">
		<div class="row">
			{% csrf_token %}
			{% for field in form %}
			<div class="form-group col-4">
				<label class="col-12">{{ field.label }}</label>
				{{ field }}
			</div>
			{% endfor %}
			<input type="submit" class="btn btn-primary" value="Create Question" />
		</div>
	</form>
</div>
<hr />

<div class="container-fluid">
	<table class="table table-striped table-sm" id="all_questions">
		<thead>
			<tr>
				<th>Question Title</th>
				<th>Question Description</th>
			</tr>
		</thead>
		<tbody>
		{% for question in questions %}
		<tr>
			<td>{{question.title}}</td>
			<td>{{question.text}}</td>
		</tr>
		{% endfor %}
		</tbody>
	</table>
	
</div>
{% endblock content %}

{% block javascript %}
<script>

$(document).ready(function (){

	$("#question-form").submit(function (e) {
		e.preventDefault();
		var serializedData = $(this).serialize();
		$.ajax({
			type: 'POST',
			url: "{% url 'polls' %}",
			data: serializedData,
			success: function (response){
				$("#question-form").trigger('reset');
				$("#id_question").focus();
				
				var instance = JSON.parse(response["instance"]);
				var field = instance[0]["fields"];
				$("#all_questions tbody").prepend(
					`<tr>
					<td>${fields["title"]||""}</td>
					<td>${fields["text"]||""}</td>
					</tr>`
				)
			},
			error: function (response) {
				console.log("error");
			}
		})
	})
	
	$("#id_question").focusout(function (e) {
		e.preventDefault();
		var question_title = $(this).val();
		$.ajax({
			type: 'GET',
			url: "{% url 'receive_Question' %}",
			data: {"question_title": question_title},
			success: function (response) {
				if(!response["valid"]){
					alert("Question with this title already exists");
					var questionTitle = $("#id_question");
					questionTitle.val("")
					questionTitle.focus()
				}
			},
			error: function (response) {
				console.log("error");
			}
		})
	})
})
</script>
{% endblock javascript %}
	