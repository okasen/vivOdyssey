{% extends "base.html" %}

{% block content %}

<div class="container-fluid">
	<form id="question-form">
		<div class="row">
			{% csrf_token %}
			{% for field in form %}
			<div class="form-group col-4">
				<label class="col-12">{{ field.label }}</label>
				{{ field }}
			</div>
			{% endfor %}
			
			<div class = "col text-center">
			<input type="submit" class="btn btn-primary" value="Create Question" />
		</div>
	</form>
</div>
<hr />

<div class="container-fluid">
	<table class="questionTable" id="all_questions">
	</table>
</div>
{% endblock content %}

{% block javascript %}
<script>
function createDeleteButton(rowId) {
	var deleteButton = document.createElement('button');
	deleteButton.textContent = 'delete';
	deleteButton.className = 'deleteClass';
	deleteButton.id = rowId;
	return deleteButton;
}
var pollsRows = document.querySelector(".questionTable");

var qTable = document.getElementById("all_questions");
var thead, tr, td;
	qTable.appendChild(thead = document.createElement("thead"));
	thead.appendChild(tr = document.createElement("tr"));
	tr.appendChild(td = document.createElement("td"));
	td.innerHTML = "Title";
	tr.appendChild(td = document.createElement("td"));
	td.innerHTML = "Description";
	tr.appendChild(td = document.createElement("td"));
	td.innerHTML = "Delete?";

{% for question in questions %}
	tr = document.createElement("tr");
	qTable.appendChild(tr);
	tr.appendChild(td = document.createElement("td"));
	td.innerHTML = "{{question.title}}";
	tr.appendChild(td = document.createElement("td"));
	td.innerHTML = "{{question.text}}";
	tr.appendChild(td = document.createElement("td"));
	td.appendChild(this.createDeleteButton("{{question.title}}"));
{% endfor %}
			
$(document).ready(function (){		
			
	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

		$("#question-form").submit(function (e) {
			e.preventDefault();
			var serializedData = $(this).serialize();
			
			$.ajax({
				type: "POST",
				url: "{% url "polls" %}",
				data: serializedData,
				success: function (response){
					console.log("success");
					$("#question-form").trigger('reset');
					$("#id_question").focus();
					
					var instance = JSON.parse(response["instance"]);
					var field = instance[0]["fields"];
					tr = document.createElement("tr");
					qTable.appendChild(tr);
					var id = field["title"]||"";
					tr.appendChild(td = document.createElement("td"));
					td.innerHTML = id;
					tr.appendChild(td = document.createElement("td"));
					td.innerHTML = field["title"]||"";
					tr.appendChild(td = document.createElement("td"));
					td.appendChild(createDeleteButton(id));
				},
					error: function (response) {
						// alert the error if any error occured
						alert(response["responseJSON"]["error"]);
				}
			})
		})
		
		$("#id_question").focusout(function (e) {
			e.preventDefault();
			var question_title = $(this).val();
			$.ajax({
				type: 'GET',
				url: "{% url 'receive_Question' %}",
				data: {"question_title": question_title},
				success: function (response) {
					if(!response["valid"]){
						alert("Question with this title already exists");
						var questionTitle = $("#id_question");
						questionTitle.val("");
						questionTitle.focus();
					}
				},
				error: function (response) {
					console.log(response);
				}
			})
		})
	});
	
function deleteFromDb(toDelete) {
	if(confirm("are you sure you want to delete this question? ID: " + toDelete));
		$.ajax({
			url: "{% url "polls" %}"
			data: {
				'csrfmiddlewaretoken': "{{ csrf_token }}"
			},
			type: "DELETE",
			dataType: "json"
		}).done(
			function(){alert("deleted");}
			).fail(
				function(){alert("error. Did not delete");}
			)
}
	
pollsRows.addEventListener('click', function(event) {

	var elementClicked = event.target;

	if (elementClicked.className === 'deleteClass'){
		console.log(event.target);
		TrToDel = event.target.parentNode.parentNode;
		TrToDel.parentNode.removeChild(TrToDel);
		deleteFromDb(event.target.id);
	}
});
</script>
{% endblock javascript %}
	